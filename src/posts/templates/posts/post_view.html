{% extends "base.html" %}
{% block title %}Home{% endblock title %}
{% load static %}

{% block content %}
<style>
    #id_author_profile_img {
        border-radius: 50%;
        vertical-align: middle;
    }
    #id_author_username {
        vertical-align: middle;
        display: inline;
    }
    #id_author_username:hover {
        text-decoration: underline;
    }
    #id_author_url {
        text-decoration: none;
        color: var(--main-text-color);
    }
    #id_like_count {
        vertical-align: middle;
        display: inline;
    }
    #id_like_picture {
        vertical-align: middle;
    }
</style>
<div class="container">
    {% for post in posts %}
    <br>
    <div class="card text-white bg-dark">
        <div class="card-header d-flex justify-content-between align-items-center">
            <a href="{% url 'account:profile' user_id=post.0.author.id %}" id="id_author_url">
                <img src="{{post.0.author.profile_image.url}}" alt="Logo" width="40px" height="40px" id="id_author_profile_img">
                <h6 class="card-text" id="id_author_username">{{post.0.author.username}}</h6>
            </a>
            {% if request.user.pk == post.0.author.pk %}
                <div class="dropdown">
                    <button class="btn btn-dark" id="id_option_dropdown" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                        <span class="material-icons">
                            more_vert
                        </span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="id_option_dropdown">
                        <li><a class="dropdown-item active" href="#">Edit</a></li>
                        <li><a class="dropdown-item" href="{% url 'posts:delete_post' post_id=post.0.pk %}">Delete</a></li>
                        <li><a class="dropdown-item" href="#">Something else here</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#">Separated link</a></li>
                    </ul>
                </div>
            {% endif %}
        </div>
        <div class="card-body">
            <p>{{post.0.content}}</p>
            {% if post.0.comments|length > 0 %}
            <p class="card-text text-muted">comments exist</p>
            {% else %}
            <p class="card-text text-muted">No comments :(</p>
            {% endif %}
            <form onsubmit="commentPost({{post.0.pk}}); return false;">
                <div class="input-group mb-3">
                    <input type="text" class="form-control custom-dark-input" id="id_comment_message_input_{{post.0.pk}}" placeholder="Comment something">
                    <button type="submit" id="id_send_message" class="btn btn-outline-primary">
                        <span class="material-icons"> send </span>
                    </button>
                </div>
            </form>
        </div>
        <div class="card-footer text-muted d-flex justify-content-between align-items-center">
            <p class="card-text">{{post.0.date_created}}</p>
            <div class="dropdown">
                <button class="btn btn-dark" id="id_like_button" onclick="likePost({{post.0.pk}});">
                    <p id="id_like_count_{{post.0.pk}}" style="vertical-align: middle; display: inline;">{{post.0.likes.all|length}}</p>
                    <span id="id_like_picture_{{post.0.pk}}" class="material-icons">
                        {% if post.1 %}
                        thumb_up
                        {% else %}
                        thumb_up_off_alt
                        {% endif %}
                    </span>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
    <br>
    <p align="center">The End - no more Posts :(</p>
</div>

<script>
    function likePost(postId) {
        const likeCount = document.querySelector(`#id_like_count_${postId}`);
        const likePicture = document.querySelector(`#id_like_picture_${postId}`);
        
        fetch("{% url 'posts:like_post' post_id=1234 %}".replace("1234", postId.toString(), {method: "POST"}))
            .then((res) => res.json())
            .then((data) => {
                likeCount.innerHTML = data["like_count"];
                
                if (data["liked"] === true) {
                    likePicture.innerHTML = "thumb_up";
                } else {
                    likePicture.innerHTML = "thumb_up_off_alt";
                }
            })
            .catch((e) => alert("Error executed while trying to like the Post :("));
    }

    function commentPost(postId) {
        const commentContent = document.querySelector(`#id_comment_message_input_${postId}`).value;

        fetch("{% url 'posts:comment_post' post_id=1234 comment_content=5678 %}".replace("1234", postId.toString().replace("5678", commentContent.toString(), {method: "POST"})))
            .then((res) => res.json())
            .then((data) => {
                console.log(data["comment_count"]);
            })
            .catch((e) => console.log("Error executed while trying to comment the Post :("))
    }
</script>
{% endblock content %}